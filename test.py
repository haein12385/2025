# -*- coding: utf-8 -*-
"""
ì‘ê¸‰ì²˜ì¹˜ & ì§„ë£Œê³¼ ì•ˆë‚´ ìŠ¤íŠ¸ë¦¼ë¦¿ ì•±

ê¸°ëŠ¥ ìš”ì•½
- ì‚¬ìš©ìê°€ ììœ ë¡­ê²Œ ì¦ìƒ/ì‚¬ê³  ìƒí™©ì„ ì…ë ¥í•˜ë©´ ì˜ë¯¸ ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ìœ ì‚¬í•œ í•­ëª©ì„ ì°¾ì•„
  1) ì¦‰ì‹œ í•´ì•¼ í•  ì‘ê¸‰ì²˜ì¹˜ ë‹¨ê³„
  2) ê¶Œì¥ ë‚´ì› ì§„ë£Œê³¼/ê¸°ê´€
  3) 119 ì—°ë½ ê¶Œê³  ê¸°ì¤€(ë ˆë“œ í”Œë˜ê·¸)
  ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.

- ì˜ë¯¸ ìœ ì‚¬ë„: SentenceTransformer(ê¶Œì¥) -> ì‹¤íŒ¨ ì‹œ TF-IDF ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ëŒ€ì²´
- í•œêµ­ ë¡œì»¬ ìš©ì–´(119, ì§„ë£Œê³¼ëª…) ì ìš©
- ì ˆëŒ€ì  ì˜í•™ì  ì¡°ì–¸ì´ ì•„ë‹ˆë©°, ê¸´ê¸‰/ì¤‘ì¦ ì˜ì‹¬ ì‹œ ì¦‰ì‹œ 119 ì—°ë½ ë° ì‘ê¸‰ì‹¤ ë°©ë¬¸ ì•ˆë‚´

ì‹¤í–‰
  $ pip install streamlit scikit-learn sentence-transformers torch
  $ streamlit run app.py

ë©”ëª¨
- ë°°í¬ í™˜ê²½ì—ì„œ sentence-transformers ì„¤ì¹˜ê°€ ì–´ë µë‹¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ "ê°„ë‹¨ ë§¤ì¹­(TF-IDF)"ë¡œ ë°”ê¿” ì‚¬ìš©í•˜ì„¸ìš”.
- í•„ìš” ì‹œ knowledge_base í•­ëª©ì„ ììœ ë¡­ê²Œ ì¶”ê°€/ìˆ˜ì •í•˜ì„¸ìš”.
"""

import os
import re
import json
from typing import List, Dict, Any

import streamlit as st
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

# ===== ì‹œë§¨í‹± ì„ë² ë”© ë¡œë”© (ì„ íƒ) =====
_ST_MODEL = None
_ST_AVAILABLE = False

@st.cache_resource(show_spinner=False)
def load_st_model(model_name: str = "sentence-transformers/paraphrase-MiniLM-L6-v2"):
    global _ST_MODEL, _ST_AVAILABLE
    try:
        from sentence_transformers import SentenceTransformer
        _ST_MODEL = SentenceTransformer(model_name)
        _ST_AVAILABLE = True
    except Exception as e:
        _ST_MODEL = None
        _ST_AVAILABLE = False
    return _ST_MODEL, _ST_AVAILABLE

# ===== ì§€ì‹ ë² ì´ìŠ¤ =====
# label: ëŒ€í‘œ ëª…ì¹­, keywords: ìœ ì‚¬ í‘œí˜„ë“¤, dept: ê¶Œì¥ ì§„ë£Œê³¼/ê¸°ê´€, aid: ì‘ê¸‰ì²˜ì¹˜ ë‹¨ê³„, red_flags: ì¦‰ì‹œ 119 ê¸°ì¤€
knowledge_base: List[Dict[str, Any]] = [
    {
        "label": "ì‹¬ì •ì§€/ì˜ì‹ ì—†ìŒ",
        "keywords": ["ì˜ì‹ì´ ì—†ë‹¤", "ë°˜ì‘ì´ ì—†ë‹¤", "ì‹¬ì¥ ë©ˆì¶¤", "ë§¥ë°• ì—†ìŒ", "ìˆ¨ì„ ì•ˆ ì‰°ë‹¤", "ì‹¬ì •ì§€"],
        "dept": "ì¦‰ì‹œ 119 / ì‘ê¸‰ì‹¤(ì‘ê¸‰ì˜í•™ê³¼)",
        "aid": [
            "119ì— ì¦‰ì‹œ ì‹ ê³ (ìŠ¤í”¼ì»¤í°). AEDê°€ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ë„ë¡ ìš”ì²­.",
            "í˜¸í¡/ë§¥ë°• í™•ì¸(10ì´ˆ ì´ë‚´). ë¹„ì •ìƒ í˜¸í¡ ë˜ëŠ” ë¬´í˜¸í¡ì´ë©´ CPR ì‹œì‘.",
            "ê°€ìŠ´ì••ë°•: ë¶„ë‹¹ 100~120íšŒ, ê¹Šì´ 5~6cm, ì™„ì „ ì´ì™„ ìœ ì§€.",
            "AED ë„ì°© ì‹œ ìŒì„± ì§€ì‹œì— ë”°ë¼ íŒ¨ë“œ ë¶€ì°© ë° ì œì„¸ë™.",
        ],
        "red_flags": ["ì˜ì‹ ì—†ìŒ", "ë¬´í˜¸í¡", "ì‹¬ì •ì§€", "ë§¥ë°• ì—†ìŒ"],
    },
    {
        "label": "ì§ˆì‹/ê¸°ë„ë§‰í˜",
        "keywords": ["ëª©ì— ê±¸ë¦¼", "ìˆ¨ ë§‰í˜", "ì§ˆì‹", "ì´ë¬¼ì§ˆ", "ê¸°ì¹¨ ì•ˆë¨", "í•˜ì„ë¦¬íˆ"],
        "dept": "ì¦‰ì‹œ 119 / ì‘ê¸‰ì‹¤",
        "aid": [
            "ê¸°ì¹¨ ê°€ëŠ¥í•˜ë©´ ê³„ì† ê¸°ì¹¨í•˜ë„ë¡ ê²©ë ¤.",
            "ê¸°ì¹¨/ì†Œë¦¬ ë¶ˆê°€Â·ì²­ìƒ‰ì¦ì´ë©´ ì„±ì¸/ì†Œì•„ í•˜ì„ë¦¬íˆë²•(ë³µë¶€ ë°€ì–´ì˜¬ë¦¬ê¸°) ì‹œí–‰.",
            "ì˜ì•„(1ì„¸ ë¯¸ë§Œ): ë“± ë‘ë“œë¦¬ê¸° 5íšŒ + ê°€ìŠ´ì••ë°• 5íšŒ ë°˜ë³µ.",
            "ì˜ì‹ ì†Œì‹¤ ì‹œ CPR ë° 119 ì‹ ê³ .",
        ],
        "red_flags": ["ìˆ¨ ëª»ì‰¼", "ì²­ìƒ‰ì¦", "ê¸°ì¹¨ ë¶ˆê°€"],
    },
    {
        "label": "ì‹¬ê·¼ê²½ìƒ‰ ì˜ì‹¬(ê°€ìŠ´ í†µì¦)",
        "keywords": ["ê°€ìŠ´í†µì¦", "ê°€ìŠ´ì´ ì¡°ì¸ë‹¤", "ì™¼íŒ” ì €ë¦¼", "ì‹ì€ë•€", "ì••ë°•ê°", "ìˆ¨ì°¸"],
        "dept": "ì¦‰ì‹œ 119 / ì‘ê¸‰ì‹¤(ì‹¬ì¥í˜ˆê´€ì„¼í„° ê°€ëŠ¥ ì‹œ)",
        "aid": [
            "ì•ˆì • ìì„¸, ê½‰ ë¼ëŠ” ì˜· í’€ê¸°.",
            "ì•„ìŠ¤í”¼ë¦° ì•Œì•½(ì„±ì¸ 300mg ë‚´ì™¸)ì„ ì•Œë ˆë¥´ê¸°/ê¸ˆê¸° ì—†ì„ ë•Œ ì”¹ì–´ ì‚¼í‚¤ëŠ” ê²ƒì„ ê³ ë ¤(í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ë³µìš© X).",
            "ì ˆëŒ€ í˜¼ì ìš´ì „ ê¸ˆì§€. ì¦‰ì‹œ 119 í˜¸ì¶œ.",
        ],
        "red_flags": ["íœ´ì‹í•´ë„ ì§€ì†ë˜ëŠ” ê°€ìŠ´í†µì¦", "í˜¸í¡ê³¤ë€", "ì‹ì€ë•€"],
    },
    {
        "label": "ë‡Œì¡¸ì¤‘ ì˜ì‹¬(FAST)",
        "keywords": ["ê°‘ìê¸° ë§ˆë¹„", "ë§ ì–´ëˆŒ", "í•œìª½ ì €ë¦¼", "ì•ˆë©´ë§ˆë¹„", "ì‹œì•¼ì¥ì• ", "ì–´ì§€ëŸ¼ ì‹¬í•¨"],
        "dept": "ì¦‰ì‹œ 119 / ë‡Œì¡¸ì¤‘ ì„¼í„° ìˆëŠ” ë³‘ì› ì‘ê¸‰ì‹¤",
        "aid": [
            "FAST í™•ì¸(ì–¼êµ´ ì²˜ì§, íŒ” ë“¤ê¸° ì–´ë ¤ì›€, ë§ ì–´ëˆŒ).",
            "ì¦ìƒ ì‹œì‘ ì‹œê° ê¸°ë¡, ìŒì‹/ìŒë£Œ ê¸ˆì§€.",
            "ì¦‰ì‹œ 119 í˜¸ì¶œ, í˜¼ì ì´ë™ ê¸ˆì§€.",
        ],
        "red_flags": ["ê°‘ì‘ìŠ¤ëŸ° ì‹ ê²½í•™ì  ê²°ì†", "ì˜ì‹ ì €í•˜"],
    },
    {
        "label": "ëŒ€ëŸ‰ì¶œí˜ˆ/ì§€í˜ˆ",
        "keywords": ["í”¼ê°€ ë©ˆì¶”ì§€ ì•ŠìŒ", "ëŒ€ëŸ‰ ì¶œí˜ˆ", "ì¹¼ì— ë² ì„", "ë™ë§¥ ì¶œí˜ˆ", "í”¼ì² ì² "],
        "dept": "ì¦‰ì‹œ 119 / ì‘ê¸‰ì‹¤",
        "aid": [
            "ê¹¨ë—í•œ ê±°ì¦ˆ/ì²œìœ¼ë¡œ ìƒì²˜ ë¶€ìœ„ë¥¼ ê°•í•˜ê²Œ ì§ì ‘ ì••ë°•.",
            "ì§€í˜ˆëŒ€ëŠ” ë§ˆì§€ë§‰ ìˆ˜ë‹¨(ì‚¬ìš©ë²• ìˆ™ì§€ ì‹œ).",
            "ì‡¼í¬ ì˜ˆë°©: ëˆ•íˆê³  ë‹¤ë¦¬ ì•½ê°„ ì˜¬ë¦¬ê¸°(ë¨¸ë¦¬Â·ì²™ì¶” ì†ìƒ ì˜ì‹¬ ì‹œ ì œì™¸).",
        ],
        "red_flags": ["ë¶„ì¶œì„± ì¶œí˜ˆ", "ì§€ì†ì  ëŒ€ëŸ‰ ì¶œí˜ˆ", "ì‡¼í¬ ì†Œê²¬"],
    },
    {
        "label": "ê³¨ì ˆ/ì—¼ì¢Œ",
        "keywords": ["ë¶€ëŸ¬ì§", "ì‚ë—", "ë°œëª© ì ‘ì§ˆë¦¼", "í†µì¦ìœ¼ë¡œ ì²´ì¤‘ ë¶€í•˜ ë¶ˆê°€", "ë¶“ê¸°", "ë©"],
        "dept": "ì •í˜•ì™¸ê³¼(ì¤‘ì¦ ì™¸ìƒÂ·ê°œë°©ì°½ì€ ì‘ê¸‰ì‹¤)",
        "aid": [
            "RICE: íœ´ì‹(Rest), ëƒ‰ì°œì§ˆ(Ice, 20ë¶„ ì´ë‚´), ì••ë°•(Compression), ê±°ìƒ(Elevation).",
            "ì‹¬í•œ ë³€í˜•/ê°œë°©ì°½/ê°ê°ì €í•˜ ì‹œ ê³ ì • í›„ ì‘ê¸‰ì‹¤.",
        ],
        "red_flags": ["ì‹¬í•œ ë³€í˜•", "ê°ê°/í˜ˆë¥˜ ì €í•˜", "ê°œë°©ì„± ê³¨ì ˆ"],
    },
    {
        "label": "í™”ìƒ",
        "keywords": ["ë°ì„", "ëœ¨ê±°ìš´ ë¬¼", "ê¸°ë¦„ì— ë°ì„", "í™”ìƒ", "ë¬¼ì§‘"],
        "dept": "ê²½ë¯¸: í”¼ë¶€ê³¼/ì™¸ê³¼ | ê´‘ë²”ìœ„/3ë„ ì˜ì‹¬: ì‘ê¸‰ì‹¤/í™”ìƒì„¼í„°",
        "aid": [
            "ì¦‰ì‹œ ë¯¸ì§€ê·¼í•œ íë¥´ëŠ” ë¬¼ë¡œ 20ë¶„ ì´ìƒ ëƒ‰ê°(ì–¼ìŒ ì§ì ‘ ëŒ€ì§€ ì•Šê¸°).",
            "ê¸ˆì†/ì˜ë³µì´ ë¶™ì—ˆìœ¼ë©´ ì–µì§€ë¡œ ë–¼ì§€ ë§ê³  ì˜ë£Œê¸°ê´€ ì´ë™.",
            "ë¬¼ì§‘ì€ í„°ëœ¨ë¦¬ì§€ ì•Šê¸°, ë©¸ê·  ê±°ì¦ˆë¡œ ë³´í˜¸.",
        ],
        "red_flags": ["ì–¼êµ´/íšŒìŒë¶€/ì†Â·ë°œ/ê´€ì ˆë¶€ ì‹¬í•œ í™”ìƒ", "ê´‘ë²”ìœ„ ìˆ˜í¬", "í¡ì… ì†ìƒ ì˜ì‹¬"],
    },
    {
        "label": "ì½”í”¼",
        "keywords": ["ì½”í”¼", "ë¹„ì¶œí˜ˆ", "ì½”ì—ì„œ í”¼", "ì½”í”¼ ë©ˆì¶”ì§€ ì•ŠìŒ"],
        "dept": "ì´ë¹„ì¸í›„ê³¼(ì§€ì† ì¶œí˜ˆì€ ì‘ê¸‰ì‹¤)",
        "aid": [
            "ëª¸ì„ ì•½ê°„ ìˆ™ì´ê³  ì½§ë§ìš¸ì„ 10ë¶„ ì´ìƒ ì§€ì† ì••ë°•.",
            "ëª© ë’¤ ì–¼ìŒì°œì§ˆì€ ë³´ì¡°, ë©´ë´‰Â·íœ´ì§€ ê¹Šìˆ™ì´ ë„£ì§€ ì•Šê¸°.",
        ],
        "red_flags": ["15ë¶„ ì´ìƒ ì§€ì† ì¶œí˜ˆ", "íƒˆìˆ˜/ì–´ì§€ëŸ¼ ë™ë°˜"],
    },
    {
        "label": "ëˆˆ ì´ë¬¼/í™”í•™ì†ìƒ",
        "keywords": ["ëˆˆì— ì´ë¬¼", "ëˆˆ ì•„í””", "í™”í•™ë¬¼ì§ˆ íŠ", "ì½˜íƒíŠ¸ë Œì¦ˆ", "ì‹œë ¥ íë¦¼"],
        "dept": "ì•ˆê³¼(í™”í•™ ì†ìƒì€ ì‘ê¸‰ì‹¤ ìš°ì„ )",
        "aid": [
            "ê¹¨ë—í•œ ìˆ˜ë—ë¬¼/ìƒë¦¬ì‹ì—¼ìˆ˜ë¡œ 15ë¶„ ì´ìƒ ì§€ì† ì„¸ì²™.",
            "ë¹„ë¹„ì§€ ë§ê¸°, ì½˜íƒíŠ¸ë Œì¦ˆ ì œê±°.",
        ],
        "red_flags": ["í™”í•™ë¬¼ì§ˆ ë…¸ì¶œ", "ì‹œë ¥ ê¸‰ê²© ì €í•˜", "ì‹¬í•œ í†µì¦"],
    },
    {
        "label": "ë²Œ/ê³¤ì¶© ì˜ì„",
        "keywords": ["ë²Œì— ì˜ì„", "ëª¨ê¸°", "ë²Œì¹¨", "ê³¤ì¶©", "ì•Œë ˆë¥´ê¸°"],
        "dept": "í”¼ë¶€ê³¼/ì•Œë ˆë¥´ê¸°ë‚´ê³¼(ì „ì‹  ë°˜ì‘ì€ ì‘ê¸‰ì‹¤)",
        "aid": [
            "ëƒ‰ì°œì§ˆ, ë¬¼ë¡œ ì„¸ì²™, ê°€ë ¤ì›€ ì™„í™” ì—°ê³  ì‚¬ìš© ê³ ë ¤.",
            "ë²Œì¹¨ì´ ë³´ì´ë©´ ì¡°ì‹¬íˆ ì œê±°(í•€ì…‹ë³´ë‹¤ ê¸ì–´ë‚´ê¸°).",
        ],
        "red_flags": ["í˜¸í¡ê³¤ë€", "ì…ìˆ /ëˆˆ ì£¼ë³€ ë¶€ì¢…", "ì „ì‹  ë‘ë“œëŸ¬ê¸°"],
    },
    {
        "label": "ê°œ/ë™ë¬¼ êµìƒ",
        "keywords": ["ê°œì— ë¬¼ë¦¼", "ê³ ì–‘ì´ì—ê²Œ ë¬¼ë¦¼", "ë™ë¬¼ì—ê²Œ ë¬¼ë¦¼", "êµìƒ", "ê´‘ê²¬ë³‘"],
        "dept": "ì‘ê¸‰ì‹¤/ì™¸ê³¼(í•„ìš” ì‹œ ì˜ˆë°©ì ‘ì¢…ì‹¤/ë³´ê±´ì†Œ ì•ˆë‚´)",
        "aid": [
            "íë¥´ëŠ” ë¬¼ê³¼ ë¹„ëˆ„ë¡œ 5ë¶„ ì´ìƒ ì„¸ì²™, ë©¸ê·  ê±°ì¦ˆë¡œ ë®ê¸°.",
            "ìƒì²˜ ê¹Šìœ¼ë©´ ì§€ì—° ë´‰í•© ê³ ë ¤, íŒŒìƒí’/ê´‘ê²¬ë³‘ ì˜ˆë°©ì ‘ì¢… í‰ê°€.",
        ],
        "red_flags": ["ê¹Šì€ ê´€í†µìƒ", "ë°œì—´Â·ë† ë°°ì¶œ", "ì•ˆë©´/ì† ë¶€ìœ„"],
    },
    {
        "label": "ë³µí†µ(ì¼ë°˜)",
        "keywords": ["ë°° ì•„í””", "ì†ì´ ë’¤í‹€ë¦¼", "ëª…ì¹˜í†µì¦", "ì„¤ì‚¬ ë³µí†µ"],
        "dept": "ë‚´ê³¼/ì†Œí™”ê¸°ë‚´ê³¼(ê¸‰ì„± ì‹¬í•˜ë©´ ì‘ê¸‰ì‹¤)",
        "aid": [
            "ê¸ˆì‹, ë¯¸ì§€ê·¼í•œ ë¬¼ ì†ŒëŸ‰ì”©, ì¦ìƒ/ë™ë°˜ ì¦ìƒ ê¸°ë¡.",
            "ì§€ì†Â·ì•…í™” ì‹œ ì˜ë£Œê¸°ê´€ ë°©ë¬¸.",
        ],
        "red_flags": ["í”¼ ì„ì¸ ë³€/í† í˜ˆ", "ê³ ì—´/íƒˆìˆ˜", "ì„ì‚°ë¶€ì˜ ë³µí†µ"],
    },
    {
        "label": "ë°œì‘/ê°„ì§ˆ ì˜ì‹¬",
        "keywords": ["ê²½ë ¨", "ë°œì‘", "ê±°í’ˆ", "ì˜ì‹ ìƒìŒ", "ê°„ì§ˆ"],
        "dept": "ì‘ê¸‰ì‹¤/ì‹ ê²½ê³¼",
        "aid": [
            "ì£¼ë³€ ìœ„í—˜ë¬¼ ì¹˜ìš°ê³  ë¨¸ë¦¬ ë³´í˜¸, ì–µì§€ë¡œ ë¶™ì¡ê±°ë‚˜ ë¬¼ê±´ ë¬¼ë¦¬ì§€ ë§ê¸°.",
            "ë°œì‘ í›„ ê¸°ë„ í™•ë³´ë¥¼ ìœ„í•´ ì˜†ìœ¼ë¡œ ëˆ•íˆê¸°(íšŒë³µìì„¸).",
        ],
        "red_flags": ["5ë¶„ ì´ìƒ ì§€ì†", "ì—°ì† ë°œì‘", "ì²« ë°œì‘"],
    },
    {
        "label": "ê³¼í˜¸í¡/ê³µí™© ì˜ì‹¬",
        "keywords": ["ê³¼í˜¸í¡", "ìˆ¨ ê°€ì¨", "ì†ë°œ ì €ë¦¼", "ë¶ˆì•ˆ", "ê³µí™©"],
        "dept": "ì •ì‹ ê±´ê°•ì˜í•™ê³¼/ë‚´ê³¼",
        "aid": [
            "ì²œì²œíˆ ì½”ë¡œ ë“¤ì´ë§ˆì‹œê³  ì…ìœ¼ë¡œ ë‚´ì‰¬ëŠ” í˜¸í¡ ìœ ë„(4-7-8 í˜¸í¡ ë“±).",
            "ì•ˆì‹¬ì‹œí‚¤ê³  ìê·¹ ì¤„ì´ê¸°.",
        ],
        "red_flags": ["ì˜ì‹ ì €í•˜", "ê°€ìŠ´í†µì¦ ë™ë°˜", "í˜¸í¡ ê³¤ë€ ì•…í™”"],
    },
]

# ë ˆë“œ í”Œë˜ê·¸ í‚¤ì›Œë“œ(ì…ë ¥ ë¬¸ì¥ì—ì„œ ë°œê²¬ë˜ë©´ ìµœìš°ì„  ê²½ê³ )
CRITICAL_TRIGGERS = [
    "ì˜ì‹ ì—†ìŒ", "ë°˜ì‘ ì—†ìŒ", "ìˆ¨ ëª»", "í˜¸í¡ ê³¤ë€", "ìˆ¨ ì‰¬ê¸° í˜ë“¦", "í”¼ ì² ì² ", "í”¼ ë©ˆì¶”ì§€", "ì‹¬ì¥", "ê°€ìŠ´ í†µì¦",
    "ë§ˆë¹„", "ë§ ì–´ëˆŒ", "ì²­ìƒ‰", "ê²½ë ¨", "ì§ˆì‹", "ì¤‘ë…", "í™”í•™ë¬¼ì§ˆ", "ì‹¬í•œ í†µì¦"
]

# ===== ìœ í‹¸ =====

def normalize(txt: str) -> str:
    txt = txt.lower().strip()
    txt = re.sub(r"\s+", " ", txt)
    return txt

@st.cache_data(show_spinner=False)
def build_tfidf_corpus(items: List[Dict[str, Any]]):
    docs = []
    for it in items:
        docs.append(it["label"] + " " + " ".join(it.get("keywords", [])))
    vec = TfidfVectorizer(ngram_range=(1,2), min_df=1)
    X = vec.fit_transform(docs)
    return vec, X

@st.cache_resource(show_spinner=False)
def build_semantic_corpus(items: List[Dict[str, Any]]):
    model, ok = load_st_model()
    if not ok:
        return None, None, False
    docs = []
    for it in items:
        docs.append(it["label"] + " " + " ".join(it.get("keywords", [])))
    emb = model.encode(docs, normalize_embeddings=True)
    return model, emb, True


def rank_with_semantic(query: str, items: List[Dict[str, Any]], topk: int = 3):
    model, emb, ok = build_semantic_corpus(items)
    if not ok:
        return []
    qv = model.encode([query], normalize_embeddings=True)
    sims = (qv @ emb.T).ravel()
    idx = sims.argsort()[::-1][:topk]
    results = [(int(i), float(sims[i])) for i in idx]
    return results


def rank_with_tfidf(query: str, items: List[Dict[str, Any]], topk: int = 3):
    vec, X = build_tfidf_corpus(items)
    q = vec.transform([query])
    sims = cosine_similarity(q, X).ravel()
    idx = sims.argsort()[::-1][:topk]
    results = [(int(i), float(sims[i])) for i in idx]
    return results


def detect_critical(query: str) -> List[str]:
    hits = []
    q = normalize(query)
    for kw in CRITICAL_TRIGGERS:
        if kw in q:
            hits.append(kw)
    return hits

# ===== UI =====
st.set_page_config(page_title="ì‘ê¸‰ì²˜ì¹˜ & ì§„ë£Œê³¼ ì•ˆë‚´", page_icon="ğŸ†˜", layout="wide")

st.title("ğŸ†˜ ì¦ìƒ ì…ë ¥ë§Œ í•˜ë©´ ì•Œë ¤ì£¼ëŠ” ì‘ê¸‰ì²˜ì¹˜ & ì§„ë£Œê³¼ ì•ˆë‚´")

with st.expander("â—ï¸ì¤‘ìš” ê³ ì§€", expanded=True):
    st.markdown(
        """
        - ì´ ë„êµ¬ëŠ” **ì‘ê¸‰ì²˜ì¹˜ ì°¸ê³ ìš©**ì…ë‹ˆë‹¤. ì •í™•í•œ ì§„ë‹¨ì„ ëŒ€ì‹ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        - **ì‹¬ê°í•œ ì¦ìƒ**(ì˜ì‹ ì†Œì‹¤, í˜¸í¡ ê³¤ë€, ëŒ€ëŸ‰ ì¶œí˜ˆ, ì‹¬í•œ ê°€ìŠ´ í†µì¦ ë“±)ì€ **ì¦‰ì‹œ 119**ì— ì—°ë½í•˜ì„¸ìš”.
        - ì…ë ¥í•œ ë‚´ìš©ì€ ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤(ë°°í¬ ë°©ì‹ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ).
        """
    )

col1, col2 = st.columns([2, 1])

with col2:
    st.subheader("âš™ï¸ ë§¤ì¹­ ì„¤ì •")
    match_mode = st.radio(
        "ë§¤ì¹­ ë°©ì‹ ì„ íƒ",
        ["ê³ ê¸‰ ì˜ë¯¸ ìœ ì‚¬ë„(ê¶Œì¥)", "ê°„ë‹¨ ë§¤ì¹­(TF-IDF)"],
        index=0
    )
    topk = st.slider("ê²°ê³¼ ê°œìˆ˜", 1, 5, 3)
    st.caption("*ì„¤ì¹˜ í™˜ê²½ì— ë”°ë¼ ì˜ë¯¸ ìœ ì‚¬ë„ ëª¨ë¸ì´ ìë™ìœ¼ë¡œ TF-IDFë¡œ ëŒ€ì²´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

with col1:
    st.subheader("ğŸ“ ì¦ìƒ/ìƒí™©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”")
                            # ì˜ˆì‹œ ì…ë ¥ ë²„íŠ¼ë“¤
    example_cases = [
        "ê°€ìŠ´ì´ ë„ˆë¬´ ì•„íŒŒìš” ì‹ì€ë•€ë‚˜ìš”",
        "ë°œëª©ì´ ë¶€ëŸ¬ì§„ ê²ƒ ê°™ì•„ìš”",
        "ëœ¨ê±°ìš´ ë¬¼ì— ì† ë°ì—ˆì–´ìš”",
        "ì½”í”¼ê°€ ë©ˆì¶”ì§€ ì•Šì•„ìš”",
        "ì‚¬ëŒì´ ê°‘ìê¸° ì“°ëŸ¬ì ¸ì„œ ìˆ¨ì„ ì•ˆ ì‰¬ì–´ìš”",
    ]
    chosen_example = st.selectbox("ì˜ˆì‹œ ì„ íƒ (ì„ íƒ ì‹œ ìë™ ì…ë ¥)", [""] + example_cases)

    query = st.text_area("ì—¬ê¸°ì— ì¦ìƒ/ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”", value=chosen_example, height=100)

    if st.button("ğŸ” í™•ì¸í•˜ê¸°") and query.strip():
        st.markdown("### ğŸ” ê²°ê³¼")

        # ë ˆë“œ í”Œë˜ê·¸ ìš°ì„  í™•ì¸
        crit = detect_critical(query)
        if crit:
            st.error(f"âš ï¸ ê¸´ê¸‰ ì‹ í˜¸ ê°ì§€: {', '.join(crit)} â†’ ì¦‰ì‹œ 119 ì—°ë½ ê¶Œê³ ")

        # ë§¤ì¹­
        if match_mode.startswith("ê³ ê¸‰"):
            results = rank_with_semantic(query, knowledge_base, topk=topk)
            if not results:  # fallback
                results = rank_with_tfidf(query, knowledge_base, topk=topk)
        else:
            results = rank_with_tfidf(query, knowledge_base, topk=topk)

        # ì¶œë ¥
        for idx, score in results:
            item = knowledge_base[idx]
            st.subheader(f"ğŸ©º {item['label']} (ìœ ì‚¬ë„ {score:.2f})")
            st.write(f"**ê¶Œì¥ ì§„ë£Œê³¼/ê¸°ê´€:** {item['dept']}")
            st.markdown("**ì‘ê¸‰ì²˜ì¹˜ ë‹¨ê³„:**")
            for step in item['aid']:
                st.markdown(f"- {step}")
            if item.get("red_flags"):
                st.markdown(f"**119 í•„ìš” ì‹ í˜¸:** {', '.join(item['red_flags'])}")
            st.divider()

